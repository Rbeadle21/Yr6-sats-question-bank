<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SATs Question Bank</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Category Tree Styles */
        .category-tree {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }
        
        .category {
            margin-bottom: 8px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }
        
        .category-header:hover {
            background: #e9ecef;
        }
        
        .category-arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 6px solid #666;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .category-arrow.expanded {
            transform: rotate(90deg);
        }
        
        .category-checkbox {
            margin-right: 8px;
        }
        
        .category-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .subcategories {
            display: none;
            margin-left: 30px;
            margin-top: 5px;
        }
        
        .subcategories.expanded {
            display: block;
        }
        
        .subcategory {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 3px;
        }
        
        .subcategory:hover {
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        .subcategory-checkbox {
            margin-right: 8px;
        }
        
        .subcategory-name {
            font-size: 13px;
            color: #555;
        }
        
        .question-count {
            margin-left: auto;
            font-size: 11px;
            color: #999;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        #stats {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Worksheet Styles */
        .worksheet-container {
            display: flex;
            gap: 20px;
        }
        
        .worksheet {
            flex: 1;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .sidebar.active {
            display: block;
        }
        
        .sidebar h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .sidebar-question {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sidebar-question:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .sidebar-question-header {
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .sidebar-question-meta {
            font-size: 11px;
            color: #999;
        }
        
        .worksheet-header {
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        .worksheet-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .worksheet-subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .question {
            margin-bottom: 25px;
            page-break-inside: avoid;
            position: relative;
        }
        
        .question.deletable {
            border-left: 4px solid #e74c3c;
            padding-left: 15px;
        }
        
        .question.editable {
            border-left: 4px solid #ff9800;
            padding-left: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .question.editable:hover {
            background: #fff3e0;
        }
        
        .edit-indicator {
            background: #fff3e0;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #e65100;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-number {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .question-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }
        
        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }
        
        .question-marks {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .question-image {
            width: 100%;
            max-width: 650px;
            height: auto;
            display: block;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .question-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .topic-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .question-meta {
            font-size: 11px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .answer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
        }
        
        .answer-label {
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 8px;
        }
        
        .answer-text {
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 18px;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header, .controls, .button-group, .sidebar {
                display: none !important;
            }
            
            .worksheet {
                box-shadow: none;
                padding: 20px;
            }
            
            .btn-danger {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üìö SATs Mathematics Question Bank</h1>
                <p style="color: #666; margin-top: 5px;">Year 6 SATs Practice Questions (2000-2025)</p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 12px; color: #999; margin-bottom: 5px;">Brought to you by</p>
                <img src="logo.png" alt="Script Work Studio" style="height: 40px; width: auto; object-fit: contain;">
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        Loading database... Please wait.
    </div>

    <div id="app" style="display: none;">
        <div class="controls">
            <div class="control-section">
                <h3>üìã Select Topics</h3>
                <div id="categoryTree" class="category-tree"></div>
            </div>

            <div class="control-section">
                <h3>‚öôÔ∏è Worksheet Settings</h3>
                
                <div class="control-group">
                    <label>Number of Questions</label>
                    <input type="number" id="questionLimit" value="10" min="1" max="100">
                </div>

                <div class="control-group">
                    <label>Difficulty Level</label>
                    <select id="difficultyFilter">
                        <option value="all">All Difficulties</option>
                        <option value="Easy">Easy Only</option>
                        <option value="Medium">Medium Only</option>
                        <option value="Hard">Hard Only</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Year Range</label>
                    <select id="yearFilter">
                        <option value="all">All Years (2000-2025)</option>
                        <option value="2020-2025">Recent (2020-2025)</option>
                        <option value="2015-2019">2015-2019</option>
                        <option value="2010-2014">2010-2014</option>
                        <option value="2005-2009">2005-2009</option>
                        <option value="2000-2004">2000-2004</option>
                    </select>
                </div>

                <div id="stats"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="generateWorksheet()">üé≤ Generate Worksheet</button>
                    <button class="btn-success" onclick="toggleAnswers()">üëÅÔ∏è Toggle Answers</button>
                    <button class="btn-secondary" onclick="printWorksheet()">üñ®Ô∏è Print Worksheet</button>
                    <button class="btn-secondary" onclick="printAnswerSheet()">üìÑ Print Answers</button>
                    <button id="editModeBtn" class="btn-secondary" onclick="toggleEditMode()">‚úèÔ∏è Edit Mode</button>
                    <button id="downloadDbBtn" class="btn-success" onclick="downloadDatabase()" style="display: none;">üíæ Download Updated Database</button>
                </div>
            </div>
        </div>

        <div class="worksheet-container">
            <div class="sidebar" id="sidebar">
                <h3>Available Questions</h3>
                <div id="sidebarQuestions"></div>
            </div>
            
            <div class="worksheet" id="worksheet">
                <div class="empty-state">
                    <p>üëÜ Select topics and click "Generate Worksheet" to begin</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = null;
        let currentQuestions = [];
        let showAnswers = false;
        let availableQuestions = [];
        let editMode = false;
        let dbModified = false;

        // Initialize SQL.js and load database
        async function initDatabase() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                const response = await fetch('sats_questions.db');
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));

                console.log('Database loaded successfully');
                loadCategoryTree();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            } catch (error) {
                console.error('Error loading database:', error);
                document.getElementById('loading').innerHTML = 
                    '‚ùå Error loading database. Please ensure sats_questions.db is in the same directory as this file.';
            }
        }

        // Load category tree with checkboxes
        function loadCategoryTree() {
            const stmt = db.prepare(`
                SELECT 
                    category,
                    subcategory,
                    COUNT(DISTINCT question_id) as count
                FROM topics
                GROUP BY category, subcategory
                ORDER BY category, subcategory
            `);

            const categories = {};
            while (stmt.step()) {
                const row = stmt.getAsObject();
                if (!categories[row.category]) {
                    categories[row.category] = [];
                }
                categories[row.category].push({
                    name: row.subcategory,
                    count: row.count
                });
            }
            stmt.free();

            const container = document.getElementById('categoryTree');
            container.innerHTML = '';

            for (const [category, subcategories] of Object.entries(categories)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';

                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `
                    <span class="category-arrow"></span>
                    <input type="checkbox" class="category-checkbox" data-category="${category}">
                    <span class="category-name">${category}</span>
                `;
                
                const subcatDiv = document.createElement('div');
                subcatDiv.className = 'subcategories';

                subcategories.forEach(sub => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'subcategory';
                    subDiv.innerHTML = `
                        <input type="checkbox" class="subcategory-checkbox" 
                               data-category="${category}" 
                               data-subcategory="${sub.name}">
                        <span class="subcategory-name">${sub.name}</span>
                        <span class="question-count">${sub.count}</span>
                    `;
                    subcatDiv.appendChild(subDiv);
                });

                // Toggle expand/collapse
                header.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    const arrow = header.querySelector('.category-arrow');
                    arrow.classList.toggle('expanded');
                    subcatDiv.classList.toggle('expanded');
                });

                // Category checkbox selects all subcategories
                const catCheckbox = header.querySelector('.category-checkbox');
                catCheckbox.addEventListener('change', (e) => {
                    const subCheckboxes = subcatDiv.querySelectorAll('.subcategory-checkbox');
                    subCheckboxes.forEach(cb => cb.checked = e.target.checked);
                    updateStats();
                });

                // Update category checkbox when subcategories change
                subcatDiv.addEventListener('change', () => {
                    const subCheckboxes = subcatDiv.querySelectorAll('.subcategory-checkbox');
                    const allChecked = Array.from(subCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(subCheckboxes).some(cb => cb.checked);
                    catCheckbox.checked = allChecked;
                    catCheckbox.indeterminate = someChecked && !allChecked;
                    updateStats();
                });

                categoryDiv.appendChild(header);
                categoryDiv.appendChild(subcatDiv);
                container.appendChild(categoryDiv);
            }
        }

        // Get selected topics
        function getSelectedTopics() {
            const checkboxes = document.querySelectorAll('.subcategory-checkbox:checked');
            return Array.from(checkboxes).map(cb => ({
                category: cb.dataset.category,
                subcategory: cb.dataset.subcategory
            }));
        }

        // Update statistics
        function updateStats() {
            const selectedTopics = getSelectedTopics();
            const stats = document.getElementById('stats');
            
            if (selectedTopics.length === 0) {
                stats.innerHTML = '<strong>No topics selected</strong>';
                return;
            }

            // Count available questions
            let totalQuestions = 0;
            selectedTopics.forEach(topic => {
                const stmt = db.prepare(`
                    SELECT COUNT(DISTINCT question_id) as count
                    FROM topics
                    WHERE category = ? AND subcategory = ?
                `);
                stmt.bind([topic.category, topic.subcategory]);
                if (stmt.step()) {
                    totalQuestions += stmt.getAsObject().count;
                }
                stmt.free();
            });

            stats.innerHTML = `
                <strong>Selected:</strong> ${selectedTopics.length} topic${selectedTopics.length !== 1 ? 's' : ''} | 
                ${totalQuestions} available questions
            `;
        }

        // Generate worksheet with random questions
        function generateWorksheet() {
            const selectedTopics = getSelectedTopics();
            
            if (selectedTopics.length === 0) {
                alert('Please select at least one topic!');
                return;
            }

            const limit = parseInt(document.getElementById('questionLimit').value);
            const difficulty = document.getElementById('difficultyFilter').value;
            const yearRange = document.getElementById('yearFilter').value;

            // Build WHERE clause for topics
            const topicConditions = selectedTopics.map((_, i) => 
                `(t.category = ? AND t.subcategory = ?)`
            ).join(' OR ');

            const topicParams = selectedTopics.flatMap(t => [t.category, t.subcategory]);

            // Build year filter
            let yearCondition = '';
            let yearParams = [];
            if (yearRange !== 'all') {
                const [startYear, endYear] = yearRange.split('-').map(Number);
                yearCondition = ' AND q.year BETWEEN ? AND ?';
                yearParams = [startYear, endYear];
            }

            // Build difficulty filter
            let difficultyCondition = '';
            let difficultyParams = [];
            if (difficulty !== 'all') {
                difficultyCondition = ' AND q.difficulty = ?';
                difficultyParams = [difficulty];
            }

            // Query for questions (with RANDOM for shuffling)
            const query = `
                SELECT DISTINCT 
                    q.id, q.year, q.paper, q.question_number, 
                    q.difficulty, q.marks, q.question, q.answer, q.image_filename
                FROM questions q
                JOIN topics t ON q.id = t.question_id
                WHERE (${topicConditions})
                ${yearCondition}
                ${difficultyCondition}
                ORDER BY RANDOM()
                LIMIT ?
            `;

            const params = [...topicParams, ...yearParams, ...difficultyParams, limit];
            const stmt = db.prepare(query);
            stmt.bind(params);

            currentQuestions = [];
            while (stmt.step()) {
                const row = stmt.getAsObject();
                
                // Get topics for this question
                const topicStmt = db.prepare(`
                    SELECT category, subcategory 
                    FROM topics 
                    WHERE question_id = ?
                `);
                topicStmt.bind([row.id]);
                const topics = [];
                while (topicStmt.step()) {
                    const t = topicStmt.getAsObject();
                    topics.push(`${t.category} > ${t.subcategory}`);
                }
                topicStmt.free();

                // Get image data
                const imgStmt = db.prepare('SELECT image_data FROM images WHERE filename = ?');
                imgStmt.bind([row.image_filename]);
                let imageData = null;
                if (imgStmt.step()) {
                    const imgRow = imgStmt.getAsObject();
                    const blob = new Blob([imgRow.image_data], { type: 'image/png' });
                    imageData = URL.createObjectURL(blob);
                }
                imgStmt.free();

                currentQuestions.push({
                    ...row,
                    topics: topics,
                    imageData: imageData
                });
            }
            stmt.free();

            renderWorksheet();
            loadAvailableQuestions();
        }

        // Render worksheet
        function renderWorksheet() {
            const worksheet = document.getElementById('worksheet');
            
            if (currentQuestions.length === 0) {
                worksheet.innerHTML = `
                    <div class="empty-state">
                        <p>üîç No questions match your filters</p>
                    </div>
                `;
                return;
            }

            const totalMarks = currentQuestions.reduce((sum, q) => sum + q.marks, 0);

            worksheet.innerHTML = `
                <div class="worksheet-header">
                    <div class="worksheet-title">SATs Mathematics Practice Worksheet</div>
                    <div class="worksheet-subtitle">
                        ${currentQuestions.length} question${currentQuestions.length !== 1 ? 's' : ''} | 
                        ${totalMarks} marks | 
                        Generated: ${new Date().toLocaleDateString()}
                    </div>
                </div>
                ${currentQuestions.map((q, index) => `
                    <div class="question ${editMode ? 'editable' : 'deletable'}" id="q-${q.id}" ${editMode ? `onclick="editQuestion(${q.id})"` : ''}>
                        ${editMode ? '<div class="edit-indicator">üñäÔ∏è Click to edit answer and topics</div>' : ''}
                        <div class="question-header">
                            <span class="question-number">Question ${index + 1}</span>
                            <div class="question-badges">
                                <span class="difficulty-badge difficulty-${q.difficulty.toLowerCase()}">${q.difficulty}</span>
                                <span class="question-marks">${q.marks} mark${q.marks > 1 ? 's' : ''}</span>
                                ${!editMode ? `<button class="btn-danger" onclick="deleteQuestion(${q.id})">‚úï Remove</button>` : ''}
                            </div>
                        </div>
                        ${q.imageData ? `<img src="${q.imageData}" alt="Question ${index + 1}" class="question-image">` : ''}
                        <div class="question-topics">
                            ${q.topics.map(t => `<span class="topic-tag">${t}</span>`).join('')}
                        </div>
                        <div class="question-meta">Year: ${q.year} | Paper: ${q.paper} | Q${q.question_number}</div>
                        ${(showAnswers || editMode) ? `
                            <div class="answer">
                                <div class="answer-label">Answer:</div>
                                <div class="answer-text">${q.answer}</div>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;

            // Show sidebar
            document.getElementById('sidebar').classList.add('active');
        }

        // Delete question from worksheet
        function deleteQuestion(questionId) {
            currentQuestions = currentQuestions.filter(q => q.id !== questionId);
            renderWorksheet();
            loadAvailableQuestions();
        }

        // Load available questions for sidebar
        function loadAvailableQuestions() {
            const selectedTopics = getSelectedTopics();
            if (selectedTopics.length === 0) return;

            const currentIds = currentQuestions.map(q => q.id);
            
            const topicConditions = selectedTopics.map((_, i) => 
                `(t.category = ? AND t.subcategory = ?)`
            ).join(' OR ');
            const topicParams = selectedTopics.flatMap(t => [t.category, t.subcategory]);

            // Get questions not currently in worksheet
            const placeholders = currentIds.length > 0 ? currentIds.map(() => '?').join(',') : '0';
            const query = `
                SELECT DISTINCT 
                    q.id, q.year, q.paper, q.question_number, 
                    q.difficulty, q.marks
                FROM questions q
                JOIN topics t ON q.id = t.question_id
                WHERE (${topicConditions})
                ${currentIds.length > 0 ? `AND q.id NOT IN (${placeholders})` : ''}
                ORDER BY RANDOM()
                LIMIT 50
            `;

            const params = [...topicParams, ...currentIds];
            const stmt = db.prepare(query);
            stmt.bind(params);

            availableQuestions = [];
            while (stmt.step()) {
                availableQuestions.push(stmt.getAsObject());
            }
            stmt.free();

            renderSidebar();
        }

        // Render sidebar
        function renderSidebar() {
            const sidebar = document.getElementById('sidebarQuestions');
            
            if (availableQuestions.length === 0) {
                sidebar.innerHTML = '<p style="color: #999; font-size: 13px;">No more questions available</p>';
                return;
            }

            sidebar.innerHTML = availableQuestions.map(q => `
                <div class="sidebar-question" onclick="addQuestion(${q.id})">
                    <div class="sidebar-question-header">
                        ${q.year} P${q.paper} Q${q.question_number} | ${q.difficulty}
                    </div>
                    <div class="sidebar-question-meta">${q.marks} mark${q.marks > 1 ? 's' : ''}</div>
                </div>
            `).join('');
        }

        // Add question from sidebar
        function addQuestion(questionId) {
            // Get full question data
            const stmt = db.prepare(`
                SELECT id, year, paper, question_number, difficulty, marks, question, answer, image_filename
                FROM questions
                WHERE id = ?
            `);
            stmt.bind([questionId]);
            
            if (stmt.step()) {
                const row = stmt.getAsObject();
                
                // Get topics
                const topicStmt = db.prepare(`
                    SELECT category, subcategory 
                    FROM topics 
                    WHERE question_id = ?
                `);
                topicStmt.bind([row.id]);
                const topics = [];
                while (topicStmt.step()) {
                    const t = topicStmt.getAsObject();
                    topics.push(`${t.category} > ${t.subcategory}`);
                }
                topicStmt.free();

                // Get image
                const imgStmt = db.prepare('SELECT image_data FROM images WHERE filename = ?');
                imgStmt.bind([row.image_filename]);
                let imageData = null;
                if (imgStmt.step()) {
                    const imgRow = imgStmt.getAsObject();
                    const blob = new Blob([imgRow.image_data], { type: 'image/png' });
                    imageData = URL.createObjectURL(blob);
                }
                imgStmt.free();

                currentQuestions.push({
                    ...row,
                    topics: topics,
                    imageData: imageData
                });

                renderWorksheet();
                loadAvailableQuestions();
            }
            stmt.free();
        }

        // Toggle answers
        function toggleAnswers() {
            showAnswers = !showAnswers;
            renderWorksheet();
        }

        // Print worksheet (no answers)
        function printWorksheet() {
            const wasShowing = showAnswers;
            showAnswers = false;
            renderWorksheet();
            setTimeout(() => {
                window.print();
                showAnswers = wasShowing;
                renderWorksheet();
            }, 100);
        }

        // Print answer sheet
        function printAnswerSheet() {
            const wasShowing = showAnswers;
            showAnswers = true;
            renderWorksheet();
            setTimeout(() => {
                window.print();
                showAnswers = wasShowing;
                renderWorksheet();
            }, 100);
        }

        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            const downloadBtn = document.getElementById('downloadDbBtn');
            
            if (editMode) {
                btn.style.background = '#ff9800';
                btn.textContent = '‚úèÔ∏è Exit Edit Mode';
                if (dbModified) {
                    downloadBtn.style.display = 'inline-block';
                }
            } else {
                btn.style.background = '';
                btn.textContent = '‚úèÔ∏è Edit Mode';
                downloadBtn.style.display = 'none';
            }
            
            renderWorksheet();
        }

        // Edit question
        function editQuestion(questionId) {
            if (!editMode) return;
            
            const question = currentQuestions.find(q => q.id === questionId);
            if (!question) return;
            
            // Get all unique categories and subcategories from database
            const stmt = db.prepare(`
                SELECT DISTINCT category, subcategory 
                FROM topics 
                ORDER BY category, subcategory
            `);
            
            const categories = {};
            while (stmt.step()) {
                const row = stmt.getAsObject();
                if (!categories[row.category]) {
                    categories[row.category] = [];
                }
                categories[row.category].push(row.subcategory);
            }
            stmt.free();
            
            // Build topic checkboxes organized by category
            let topicHTML = '';
            for (const [category, subcategories] of Object.entries(categories)) {
                topicHTML += `<div style="margin-bottom: 15px;">`;
                topicHTML += `<strong style="display: block; margin-bottom: 8px; color: #2c3e50;">${category}</strong>`;
                subcategories.forEach(sub => {
                    const topicStr = `${category} > ${sub}`;
                    const checked = question.topics.includes(topicStr) ? 'checked' : '';
                    topicHTML += `
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">
                            <input type="checkbox" class="edit-topic-checkbox" value="${topicStr}" ${checked}>
                            ${sub}
                        </label>
                    `;
                });
                topicHTML += `</div>`;
            }
            
            // Create edit panel
            let html = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                            max-width: 700px; width: 90%; z-index: 1000; max-height: 85vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Edit Question ${question.question_number}</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Question ${question.year} Paper ${question.paper} Q${question.question_number}</strong><br>
                        <span style="font-size: 12px; color: #666;">${question.difficulty} | ${question.marks} mark${question.marks > 1 ? 's' : ''}</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px;">Answer:</label>
                        <textarea id="editAnswer" rows="4"
                               style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; 
                                      font-size: 14px; font-family: inherit; resize: vertical;">${question.answer}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px;">Topics (select all that apply):</label>
                        <div style="max-height: 300px; overflow-y: auto; padding: 15px; 
                                    border: 2px solid #e0e0e0; border-radius: 5px; background: white;">
                            ${topicHTML}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeEditPanel()" 
                                style="padding: 10px 20px; background: #95a5a6; color: white; border: none; 
                                       border-radius: 5px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button onclick="saveEdit(${questionId})" 
                                style="padding: 10px 20px; background: #27ae60; color: white; border: none; 
                                       border-radius: 5px; cursor: pointer; font-weight: 600;">üíæ Save Changes</button>
                    </div>
                </div>
                <div onclick="closeEditPanel()" 
                     style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
            `;
            
            const panel = document.createElement('div');
            panel.id = 'editPanel';
            panel.innerHTML = html;
            document.body.appendChild(panel);
        }

        function closeEditPanel() {
            const panel = document.getElementById('editPanel');
            if (panel) panel.remove();
        }

        function saveEdit(questionId) {
            const question = currentQuestions.find(q => q.id === questionId);
            if (!question) return;
            
            // Get new answer
            const newAnswer = document.getElementById('editAnswer').value.trim();
            if (!newAnswer) {
                alert('Answer cannot be empty!');
                return;
            }
            
            // Get selected topics
            const selectedTopics = Array.from(document.querySelectorAll('.edit-topic-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedTopics.length === 0) {
                alert('Please select at least one topic!');
                return;
            }
            
            // Update in-memory question data
            question.answer = newAnswer;
            question.topics = selectedTopics;
            
            // Update database
            db.run('UPDATE questions SET answer = ? WHERE id = ?', [newAnswer, questionId]);
            
            // Delete old topics
            db.run('DELETE FROM topics WHERE question_id = ?', [questionId]);
            
            // Insert new topics
            selectedTopics.forEach(topic => {
                const parts = topic.split(' > ');
                if (parts.length === 2) {
                    db.run('INSERT INTO topics (question_id, category, subcategory) VALUES (?, ?, ?)', 
                           [questionId, parts[0], parts[1]]);
                }
            });
            
            dbModified = true;
            document.getElementById('downloadDbBtn').style.display = 'inline-block';
            
            closeEditPanel();
            renderWorksheet();
            alert('‚úÖ Changes saved! Click "Download Updated Database" when you\'re done editing.');
        }

        // Download updated database
        function downloadDatabase() {
            if (!dbModified) {
                alert('No changes have been made to the database.');
                return;
            }
            
            const confirmed = confirm(
                'üì• Download Updated Database\n\n' +
                'This will download a new sats_questions.db file with your changes.\n\n' +
                'To update the website:\n' +
                '1. Download this file\n' +
                '2. Replace the old sats_questions.db in your GitHub repository\n' +
                '3. Commit and push the changes\n\n' +
                'Continue with download?'
            );
            
            if (!confirmed) return;
            
            try {
                const data = db.export();
                const blob = new Blob([data], { type: 'application/x-sqlite3' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sats_questions_updated.db';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Database downloaded successfully!\n\nFilename: sats_questions_updated.db\n\nReplace your old database file with this one.');
            } catch (error) {
                console.error('Error exporting database:', error);
                alert('‚ùå Error downloading database. Check console for details.');
            }
        }

        // Initialize on page load
        initDatabase();
    </script>
</body>
</html>
