<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SATs Question Bank</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .branding {
            text-align: right;
        }
        
        .branding-text {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .branding img {
            height: 40px;
            width: auto;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .category-tree {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }
        
        .category {
            margin-bottom: 8px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }
        
        .category-header:hover {
            background: #e9ecef;
        }
        
        .category-arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 6px solid #666;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .category-arrow.expanded {
            transform: rotate(90deg);
        }
        
        .category-checkbox {
            margin-right: 8px;
        }
        
        .category-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .subcategories {
            display: none;
            margin-left: 30px;
            margin-top: 5px;
        }
        
        .subcategories.expanded {
            display: block;
        }
        
        .subcategory {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 3px;
        }
        
        .subcategory:hover {
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        .subcategory-checkbox {
            margin-right: 8px;
        }
        
        .subcategory-name {
            font-size: 13px;
            color: #555;
        }
        
        .question-count {
            margin-left: auto;
            font-size: 11px;
            color: #999;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Support Section */
        .support-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .support-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .support-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .support-card p {
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .btn-coffee {
            display: inline-block;
            background: #FFDD00;
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 700;
            text-decoration: none;
            transition: background 0.2s;
        }

        .btn-coffee:hover {
            background: #f0cc00;
        }

        .btn-email {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 700;
            text-decoration: none;
            transition: background 0.2s;
        }

        .btn-email:hover {
            background: #2980b9;
        }

        @media print {
            .support-section { display: none; }
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        #stats {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .worksheet-container {
            display: flex;
            gap: 20px;
        }
        
        .worksheet {
            flex: 1;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .sidebar.active {
            display: block;
        }
        
        .sidebar h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .sidebar-filters {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .sidebar-filter-group {
            margin-bottom: 10px;
        }
        
        .sidebar-filter-group:last-child {
            margin-bottom: 0;
        }
        
        .sidebar-filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            display: block;
            margin-bottom: 3px;
        }
        
        .sidebar-filter-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .sidebar-question {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .sidebar-question:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .question-preview-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 10000;
        }
        
        .question-preview-modal.active {
            display: block;
        }
        
        .preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        }
        
        .preview-overlay.active {
            display: block;
        }
        
        .question-preview-modal img {
            width: 100%;
            max-width: 800px;
            height: auto;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .preview-title {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .preview-close {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .preview-close:hover {
            background: #c0392b;
        }
        
        .sidebar-question-header {
            font-weight: 600;
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .sidebar-question-meta {
            font-size: 11px;
            color: #999;
        }
        
        .worksheet-header {
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        .worksheet-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .worksheet-subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .question {
            margin-bottom: 25px;
            page-break-inside: avoid;
            position: relative;
            cursor: move;
        }
        
        .question.deletable {
            border-left: 4px solid #e74c3c;
            padding-left: 15px;
        }
        
        .question.editable {
            border-left: 4px solid #ff9800;
            padding-left: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .question.editable:hover {
            background: #fff3e0;
        }
        
        .question.dragging {
            opacity: 0.5;
        }
        
        .question.drag-over {
            border-top: 3px solid #3498db;
        }
        
        .drag-handle {
            display: inline-block;
            cursor: move;
            padding: 4px 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .drag-handle:hover {
            background: #bdc3c7;
        }
        
        .edit-indicator {
            background: #fff3e0;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #e65100;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-number {
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .question-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }
        
        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }
        
        .question-marks {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .question-image {
            width: 100%;
            max-width: 650px;
            height: auto;
            display: block;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .question-image-container {
            position: relative;
            display: inline-block;
            max-width: 650px;
        }
        
        .question-number-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgb(41, 128, 185);
            color: white;
            font-weight: bold;
            font-size: 24px;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            border: 2px solid white;
        }
        
        .question-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .topic-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .question-meta {
            font-size: 11px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .answer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
            margin-top: 10px;
        }
        
        .answer-label {
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 8px;
        }
        
        .answer-text {
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 18px;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header, .controls, .button-group, .sidebar {
                display: none !important;
            }
            
            .worksheet {
                box-shadow: none;
                padding: 20px;
            }
            
            .btn-danger {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üìö SATs Mathematics Question Bank</h1>
                <p class="subtitle">Year 6 SATs Practice Questions (2000-2025)</p>
            </div>
            <div class="branding">
                <p class="branding-text">Brought to you by</p>
                <img src="logo.png" alt="Script Work Studio">
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        Loading questions... Please wait.
    </div>

    <div id="app" style="display: none;">
        <div class="controls">
            <div class="control-section">
                <h3>üìã Select Topics</h3>
                <div id="categoryTree" class="category-tree"></div>
            </div>

            <div class="control-section">
                <h3>‚öôÔ∏è Worksheet Settings</h3>
                
                <div class="control-group">
                    <label>Number of Questions</label>
                    <input type="number" id="questionLimit" value="10" min="1" max="100">
                </div>

                <div class="control-group">
                    <label>Difficulty Level</label>
                    <select id="difficultyFilter">
                        <option value="all">All Difficulties</option>
                        <option value="Easy">Easy Only</option>
                        <option value="Medium">Medium Only</option>
                        <option value="Hard">Hard Only</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Year Range</label>
                    <select id="yearFilter">
                        <option value="all">All Years (2000-2025)</option>
                        <option value="2020-2025">Recent (2020-2025)</option>
                        <option value="2015-2019">2015-2019</option>
                        <option value="2010-2014">2010-2014</option>
                        <option value="2005-2009">2005-2009</option>
                        <option value="2000-2004">2000-2004</option>
                    </select>
                </div>

                <div id="stats"></div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="generateWorksheet()">üé≤ Generate Worksheet</button>
                    <button class="btn-success" onclick="toggleAnswers()">üëÅÔ∏è Toggle Answers</button>
                    <button class="btn-secondary" onclick="printWorksheet()">üñ®Ô∏è Print Worksheet</button>
                    <button class="btn-secondary" onclick="printAnswerSheet()">üìÑ Print Answers</button>
                    <button id="editModeBtn" class="btn-secondary" onclick="toggleEditMode()">‚úèÔ∏è Edit Mode</button>
                    <button id="downloadBtn" class="btn-success" onclick="downloadJSON()" style="display: none;">üíæ Download Updated JSON</button>
                </div>
            </div>
        </div>

        <div class="worksheet-container">
            <div class="sidebar" id="sidebar">
                <h3>Available Questions</h3>
                <div class="sidebar-filters">
                    <div class="sidebar-filter-group">
                        <label>Difficulty</label>
                        <select id="sidebarDifficulty" onchange="loadAvailableQuestions()">
                            <option value="all">All</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="sidebar-filter-group">
                        <label>Year</label>
                        <select id="sidebarYear" onchange="loadAvailableQuestions()">
                            <option value="all">All Years</option>
                            <option value="2020-2025">2020-2025</option>
                            <option value="2015-2019">2015-2019</option>
                            <option value="2010-2014">2010-2014</option>
                            <option value="2005-2009">2005-2009</option>
                            <option value="2000-2004">2000-2004</option>
                        </select>
                    </div>
                </div>
                <div id="sidebarQuestions"></div>
            </div>
            
            <div class="worksheet" id="worksheet">
                <div class="empty-state">
                    <p>üëÜ Select topics and click "Generate Worksheet" to begin</p>
                </div>
            </div>
        </div>
    </div>

    <div class="preview-overlay" id="previewOverlay" onclick="closePreview()"></div>
    <div class="question-preview-modal" id="previewModal">
        <div class="preview-header">
            <span class="preview-title" id="previewTitle"></span>
            <button class="preview-close" onclick="closePreview()">‚úï Close</button>
        </div>
        <img id="previewImage" src="" alt="Question Preview">
    </div>

    <!-- Support Section -->
    <div class="support-section">
        <div class="support-card">
            <h3>‚òï Support This Project</h3>
            <p>This tool is completely free to use. If you find it helpful in your classroom or at home, consider buying me a coffee ‚Äî it helps keep the project going and motivates future improvements!</p>
            <a href="https://buymeacoffee.com/scriptworkstudio" target="_blank" rel="noopener" class="btn-coffee">‚òï Buy Me a Coffee</a>
        </div>
        <div class="support-card">
            <h3>üì¨ Feedback & Issues</h3>
            <p>Spotted a bug, have a suggestion, or noticed a question that needs updating? We'd love to hear from you ‚Äî your feedback genuinely helps make this resource better for everyone.</p>
            <a href="mailto:scriptworkstudio@hotmail.com" class="btn-email">‚úâÔ∏è scriptworkstudio@hotmail.com</a>
        </div>
    </div>

    <script>
        let questionsData = [];
        let currentQuestions = [];
        let showAnswers = false;
        let editMode = false;
        let availableQuestions = [];
        const imageFolder = 'images/';

        // Load questions from JSON
        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                const data = await response.json();
                questionsData = data.questions;
                
                console.log(`Loaded ${questionsData.length} questions`);
                loadCategoryTree();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #e74c3c;">
                        ‚ùå Error loading questions.json<br>
                        <span style="font-size: 14px;">Please ensure questions.json is in the same directory.</span>
                    </div>
                `;
            }
        }

        // Load category tree
        function loadCategoryTree() {
            const categories = {};
            
            // Build category structure
            questionsData.forEach(q => {
                q.topic.forEach(topicStr => {
                    const parts = topicStr.split(' > ');
                    if (parts.length === 2) {
                        const [category, subcategory] = parts;
                        if (!categories[category]) {
                            categories[category] = {};
                        }
                        if (!categories[category][subcategory]) {
                            categories[category][subcategory] = 0;
                        }
                        categories[category][subcategory]++;
                    }
                });
            });

            const container = document.getElementById('categoryTree');
            container.innerHTML = '';

            for (const [category, subcategories] of Object.entries(categories).sort()) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';

                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerHTML = `
                    <span class="category-arrow"></span>
                    <input type="checkbox" class="category-checkbox" data-category="${category}">
                    <span class="category-name">${category}</span>
                `;
                
                const subcatDiv = document.createElement('div');
                subcatDiv.className = 'subcategories';

                Object.entries(subcategories).sort().forEach(([sub, count]) => {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'subcategory';
                    subDiv.innerHTML = `
                        <input type="checkbox" class="subcategory-checkbox" 
                               data-category="${category}" 
                               data-subcategory="${sub}">
                        <span class="subcategory-name">${sub}</span>
                        <span class="question-count">${count}</span>
                    `;
                    subcatDiv.appendChild(subDiv);
                });

                // Toggle expand/collapse
                header.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') return;
                    const arrow = header.querySelector('.category-arrow');
                    arrow.classList.toggle('expanded');
                    subcatDiv.classList.toggle('expanded');
                });

                // Category checkbox selects all subcategories
                const catCheckbox = header.querySelector('.category-checkbox');
                catCheckbox.addEventListener('change', (e) => {
                    const subCheckboxes = subcatDiv.querySelectorAll('.subcategory-checkbox');
                    subCheckboxes.forEach(cb => cb.checked = e.target.checked);
                    updateStats();
                });

                // Update category checkbox when subcategories change
                subcatDiv.addEventListener('change', () => {
                    const subCheckboxes = subcatDiv.querySelectorAll('.subcategory-checkbox');
                    const allChecked = Array.from(subCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(subCheckboxes).some(cb => cb.checked);
                    catCheckbox.checked = allChecked;
                    catCheckbox.indeterminate = someChecked && !allChecked;
                    updateStats();
                });

                categoryDiv.appendChild(header);
                categoryDiv.appendChild(subcatDiv);
                container.appendChild(categoryDiv);
            }
        }

        // Get selected topics
        function getSelectedTopics() {
            const checkboxes = document.querySelectorAll('.subcategory-checkbox:checked');
            return Array.from(checkboxes).map(cb => ({
                category: cb.dataset.category,
                subcategory: cb.dataset.subcategory
            }));
        }

        // Update statistics
        function updateStats() {
            const selectedTopics = getSelectedTopics();
            const stats = document.getElementById('stats');
            
            if (selectedTopics.length === 0) {
                stats.innerHTML = '<strong>No topics selected</strong>';
                return;
            }

            const matchingQuestions = questionsData.filter(q => 
                q.topic.some(t => {
                    const parts = t.split(' > ');
                    if (parts.length !== 2) return false;
                    return selectedTopics.some(sel => 
                        sel.category === parts[0] && sel.subcategory === parts[1]
                    );
                })
            );

            stats.innerHTML = `
                <strong>Selected:</strong> ${selectedTopics.length} topic${selectedTopics.length !== 1 ? 's' : ''} | 
                ${matchingQuestions.length} available questions
            `;
        }

        // Shuffle array
        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Generate worksheet
        function generateWorksheet() {
            const selectedTopics = getSelectedTopics();
            
            if (selectedTopics.length === 0) {
                alert('Please select at least one topic!');
                return;
            }

            const limit = parseInt(document.getElementById('questionLimit').value);
            const difficulty = document.getElementById('difficultyFilter').value;
            const yearRange = document.getElementById('yearFilter').value;

            // Filter questions
            let filteredQuestions = questionsData.filter(q => {
                // Check topics
                const hasMatchingTopic = q.topic.some(t => {
                    const parts = t.split(' > ');
                    if (parts.length !== 2) return false;
                    return selectedTopics.some(sel => 
                        sel.category === parts[0] && sel.subcategory === parts[1]
                    );
                });
                if (!hasMatchingTopic) return false;

                // Check difficulty
                if (difficulty !== 'all' && q.difficulty !== difficulty) return false;

                // Check year range
                if (yearRange !== 'all') {
                    const [startYear, endYear] = yearRange.split('-').map(Number);
                    if (q.year < startYear || q.year > endYear) return false;
                }

                return true;
            });

            // Shuffle and limit
            filteredQuestions = shuffle(filteredQuestions).slice(0, limit);
            currentQuestions = filteredQuestions;

            renderWorksheet();
            loadAvailableQuestions();
        }

        // Render worksheet
        function renderWorksheet() {
            const worksheet = document.getElementById('worksheet');
            
            if (currentQuestions.length === 0) {
                worksheet.innerHTML = `
                    <div class="empty-state">
                        <p>üîç No questions match your filters</p>
                    </div>
                `;
                return;
            }

            const totalMarks = currentQuestions.reduce((sum, q) => sum + q.marks, 0);

            worksheet.innerHTML = `
                <div class="worksheet-header">
                    <div class="worksheet-title">SATs Mathematics Practice Worksheet</div>
                    <div class="worksheet-subtitle">
                        ${currentQuestions.length} question${currentQuestions.length !== 1 ? 's' : ''} | 
                        ${totalMarks} marks | 
                        Generated: ${new Date().toLocaleDateString()}
                    </div>
                </div>
                ${currentQuestions.map((q, index) => `
                    <div class="question ${editMode ? 'editable' : 'deletable'}" 
                         id="q-${q.id}" 
                         draggable="true"
                         data-index="${index}"
                         ${editMode ? `onclick="editQuestion(${q.id})"` : ''}>
                        ${editMode ? '<div class="edit-indicator">üñäÔ∏è Click to edit answer and topics</div>' : ''}
                        <div class="question-header">
                            <span class="question-number">
                                <span class="drag-handle" title="Drag to reorder">‚ò∞</span>
                                Question ${index + 1}
                            </span>
                            <div class="question-badges">
                                <span class="difficulty-badge difficulty-${q.difficulty.toLowerCase()}">${q.difficulty}</span>
                                <span class="question-marks">${q.marks} mark${q.marks > 1 ? 's' : ''}</span>
                                ${!editMode ? `<button class="btn-danger" onclick="event.stopPropagation(); deleteQuestion(${q.id})">‚úï Remove</button>` : ''}
                            </div>
                        </div>
                        <div class="question-image-container">
                            <div class="question-number-overlay">${index + 1}</div>
                            <img src="${imageFolder}${q.image}" 
                                 alt="Question ${index + 1}" 
                                 class="question-image"
                                 onerror="this.style.display='none'; this.previousElementSibling.style.display='none';">
                        </div>
                        <div class="question-topics">
                            ${q.topic.map(t => `<span class="topic-tag">${t}</span>`).join('')}
                        </div>
                        <div class="question-meta">Year: ${q.year} | Paper: ${q.paper} | Q${q.question_number}</div>
                        ${(showAnswers || editMode) ? `
                            <div class="answer">
                                <div class="answer-label">Answer:</div>
                                <div class="answer-text">${q.answer}</div>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;

            document.getElementById('sidebar').classList.add('active');
            
            // Add drag and drop event listeners
            setupDragAndDrop();
        }
        
        // Setup drag and drop for reordering questions
        function setupDragAndDrop() {
            const questions = document.querySelectorAll('.question');
            let draggedElement = null;
            
            questions.forEach(question => {
                question.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.innerHTML);
                });
                
                question.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    questions.forEach(q => q.classList.remove('drag-over'));
                });
                
                question.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (draggedElement !== this) {
                        this.classList.add('drag-over');
                    }
                    return false;
                });
                
                question.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });
                
                question.addEventListener('drop', function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    if (draggedElement !== this) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(this.dataset.index);
                        
                        // Reorder the array
                        const draggedQuestion = currentQuestions[draggedIndex];
                        currentQuestions.splice(draggedIndex, 1);
                        currentQuestions.splice(targetIndex, 0, draggedQuestion);
                        
                        renderWorksheet();
                    }
                    
                    this.classList.remove('drag-over');
                    return false;
                });
            });
        }

        // Delete question
        function deleteQuestion(questionId) {
            currentQuestions = currentQuestions.filter(q => q.id !== questionId);
            renderWorksheet();
            loadAvailableQuestions();
        }

        // Load available questions for sidebar
        function loadAvailableQuestions() {
            const selectedTopics = getSelectedTopics();
            if (selectedTopics.length === 0) return;

            const currentIds = currentQuestions.map(q => q.id);
            const sidebarDifficulty = document.getElementById('sidebarDifficulty').value;
            const sidebarYear = document.getElementById('sidebarYear').value;
            
            availableQuestions = questionsData.filter(q => {
                if (currentIds.includes(q.id)) return false;
                
                // Check topics
                const hasMatchingTopic = q.topic.some(t => {
                    const parts = t.split(' > ');
                    if (parts.length !== 2) return false;
                    return selectedTopics.some(sel => 
                        sel.category === parts[0] && sel.subcategory === parts[1]
                    );
                });
                if (!hasMatchingTopic) return false;
                
                // Check difficulty filter
                if (sidebarDifficulty !== 'all' && q.difficulty !== sidebarDifficulty) return false;
                
                // Check year filter
                if (sidebarYear !== 'all') {
                    const [startYear, endYear] = sidebarYear.split('-').map(Number);
                    if (q.year < startYear || q.year > endYear) return false;
                }
                
                return true;
            });

            availableQuestions = shuffle(availableQuestions).slice(0, 50);
            renderSidebar();
        }

        // Render sidebar
        function renderSidebar() {
            const sidebar = document.getElementById('sidebarQuestions');
            
            if (availableQuestions.length === 0) {
                sidebar.innerHTML = '<p style="color: #999; font-size: 13px;">No more questions available</p>';
                return;
            }

            sidebar.innerHTML = availableQuestions.map(q => `
                <div class="sidebar-question" onclick="addQuestion(${q.id})">
                    <div class="sidebar-question-header">
                        ${q.year} P${q.paper} Q${q.question_number} | ${q.difficulty}
                        <button onclick="event.stopPropagation(); showPreview(${q.id})" 
                                style="float: right; padding: 2px 6px; font-size: 10px; background: #3498db; 
                                       color: white; border: none; border-radius: 3px; cursor: pointer;"
                                title="Preview question">üëÅÔ∏è</button>
                    </div>
                    <div class="sidebar-question-meta">${q.marks} mark${q.marks > 1 ? 's' : ''}</div>
                </div>
            `).join('');
        }
        
        // Show preview modal
        function showPreview(questionId) {
            const question = questionsData.find(q => q.id === questionId);
            if (!question) return;
            
            document.getElementById('previewTitle').textContent = 
                `${question.year} Paper ${question.paper} Q${question.question_number} - ${question.difficulty} (${question.marks} mark${question.marks > 1 ? 's' : ''})`;
            document.getElementById('previewImage').src = imageFolder + question.image;
            document.getElementById('previewModal').classList.add('active');
            document.getElementById('previewOverlay').classList.add('active');
        }
        
        // Close preview modal
        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
            document.getElementById('previewOverlay').classList.remove('active');
        }

        // Add question from sidebar
        function addQuestion(questionId) {
            const question = questionsData.find(q => q.id === questionId);
            if (question) {
                currentQuestions.push(question);
                renderWorksheet();
                loadAvailableQuestions();
            }
        }

        // Toggle answers
        function toggleAnswers() {
            showAnswers = !showAnswers;
            renderWorksheet();
        }

        // Print worksheet
        function printWorksheet() {
            const wasShowing = showAnswers;
            showAnswers = false;
            renderWorksheet();
            setTimeout(() => {
                window.print();
                showAnswers = wasShowing;
                renderWorksheet();
            }, 100);
        }

        // Print answer sheet
        function printAnswerSheet() {
            const wasShowing = showAnswers;
            showAnswers = true;
            renderWorksheet();
            setTimeout(() => {
                window.print();
                showAnswers = wasShowing;
                renderWorksheet();
            }, 100);
        }

        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (editMode) {
                btn.style.background = '#ff9800';
                btn.textContent = '‚úèÔ∏è Exit Edit Mode';
                downloadBtn.style.display = 'inline-block';
            } else {
                btn.style.background = '';
                btn.textContent = '‚úèÔ∏è Edit Mode';
                downloadBtn.style.display = 'none';
            }
            
            renderWorksheet();
        }

        // Edit question
        function editQuestion(questionId) {
            if (!editMode) return;
            
            const question = questionsData.find(q => q.id === questionId);
            if (!question) return;
            
            // Get all unique categories and subcategories
            const categories = {};
            questionsData.forEach(q => {
                q.topic.forEach(topicStr => {
                    const parts = topicStr.split(' > ');
                    if (parts.length === 2) {
                        const [category, subcategory] = parts;
                        if (!categories[category]) {
                            categories[category] = new Set();
                        }
                        categories[category].add(subcategory);
                    }
                });
            });
            
            // Build topic checkboxes
            let topicHTML = '';
            for (const [category, subcategories] of Object.entries(categories).sort()) {
                topicHTML += `<div style="margin-bottom: 15px;">`;
                topicHTML += `<strong style="display: block; margin-bottom: 8px; color: #2c3e50;">${category}</strong>`;
                Array.from(subcategories).sort().forEach(sub => {
                    const topicStr = `${category} > ${sub}`;
                    const checked = question.topic.includes(topicStr) ? 'checked' : '';
                    topicHTML += `
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">
                            <input type="checkbox" class="edit-topic-checkbox" value="${topicStr}" ${checked}>
                            ${sub}
                        </label>
                    `;
                });
                topicHTML += `</div>`;
            }
            
            // Create edit panel
            let html = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                            max-width: 700px; width: 90%; z-index: 1000; max-height: 85vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Edit Question ${question.question_number}</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Question ${question.year} Paper ${question.paper} Q${question.question_number}</strong><br>
                        <span style="font-size: 12px; color: #666;">${question.difficulty} | ${question.marks} mark${question.marks > 1 ? 's' : ''}</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px;">Answer:</label>
                        <textarea id="editAnswer" rows="4"
                               style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; 
                                      font-size: 14px; font-family: inherit; resize: vertical;">${question.answer}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px;">Topics (select all that apply):</label>
                        <div style="max-height: 300px; overflow-y: auto; padding: 15px; 
                                    border: 2px solid #e0e0e0; border-radius: 5px; background: white;">
                            ${topicHTML}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeEditPanel()" 
                                style="padding: 10px 20px; background: #95a5a6; color: white; border: none; 
                                       border-radius: 5px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button onclick="saveEdit(${questionId})" 
                                style="padding: 10px 20px; background: #27ae60; color: white; border: none; 
                                       border-radius: 5px; cursor: pointer; font-weight: 600;">üíæ Save Changes</button>
                    </div>
                </div>
                <div onclick="closeEditPanel()" 
                     style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
            `;
            
            const panel = document.createElement('div');
            panel.id = 'editPanel';
            panel.innerHTML = html;
            document.body.appendChild(panel);
        }

        function closeEditPanel() {
            const panel = document.getElementById('editPanel');
            if (panel) panel.remove();
        }

        function saveEdit(questionId) {
            const question = questionsData.find(q => q.id === questionId);
            if (!question) return;
            
            const newAnswer = document.getElementById('editAnswer').value.trim();
            if (!newAnswer) {
                alert('Answer cannot be empty!');
                return;
            }
            
            const selectedTopics = Array.from(document.querySelectorAll('.edit-topic-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedTopics.length === 0) {
                alert('Please select at least one topic!');
                return;
            }
            
            question.answer = newAnswer;
            question.topic = selectedTopics;
            
            closeEditPanel();
            renderWorksheet();
            alert('‚úÖ Changes saved! Click "Download Updated JSON" when done editing.');
        }

        // Download updated JSON
        function downloadJSON() {
            const json = JSON.stringify({questions: questionsData}, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'questions_updated.json';
            a.click();
            
            URL.revokeObjectURL(url);
            alert('‚úÖ Downloaded! Replace your old questions.json with this file.');
        }

        // Initialize
        loadQuestions();
    </script>
</body>
</html>
